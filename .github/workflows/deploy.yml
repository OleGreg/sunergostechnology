name: SunergosTechnology CD

on:
  push:
    branches: [ "master" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # Install dependencies and clean project
    - name: Set Up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.x'  # Use a stable Node.js version

    - name: Install and Build Theme
      working-directory: web/app/themes/sunergos-wordpress
      run: |
        npm install
        npm run clean  # Ensure old artifacts are removed
        yarn build  # Run the build step
        if [ $? -ne 0 ]; then
          echo "Build failed. Debugging logs:" && cat logs/build.log
          exit 1
        fi

    # Sync files to the remote server
    - name: Sync
      env:
        dest: 'root@sunergostechnology.com:/var/www/sunergostechnology.com'
      run: |
        echo "${{secrets.DO_SSH_PRIVATE_KEY}}" > deploy_key
        chmod 600 ./deploy_key
        rsync -chav --delete \
        -e 'ssh -i ./deploy_key -o StrictHostKeyChecking=no' \
        --exclude /deploy_key \
        --exclude /.git/ \
        --exclude /.github/ \
        --exclude /node_modules/ \
        --exclude .env \
        --exclude web/app/uploads \
        ./ ${{env.dest}}
    - name: Change Ownership of Deployed Files
      run: |
        ssh -i ./deploy_key -o StrictHostKeyChecking=no root@sunergostechnology.com "chown -R www-data:www-data /var/www/sunergostechnology.com"
